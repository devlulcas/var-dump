---
import Layout from '../../../layouts/Layout.astro';
import { app } from '../../../lib/firebase/server';
import { getFirestore } from 'firebase-admin/firestore';
import type { Post } from '../../../lib/posts/types';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/404');
}

const db = getFirestore(app);
const postsRef = db.collection('posts');
const postSnapshot = await postsRef.doc(id).get();

if (!postSnapshot.exists) {
  return Astro.redirect('/404');
}

const post = postSnapshot.data() as Post;
---

<Layout title="Edit {post.name}">
  <p>Here you can edit or delete your post's data.</p>

  <form method="POST" action={`/api/posts/${id}`}>
    <label for="content">content</label>
    <input type="text" id="content" name="content" value={post.content} />
    <button type="submit">Edit post</button>
  </form>

  <button type="button" id="delete-document">Delete</button>
</Layout>

<script>
  const deleteButton = document.getElementById(
    'delete-document'
  ) as HTMLButtonElement;

  const url = document.querySelector('form')?.getAttribute('action') as string;

  deleteButton.addEventListener('click', async () => {
    const response = await fetch(url, {
      method: 'DELETE',
    });

    if (response.redirected) {
      window.location.assign(response.url);
    }
  });
</script>
